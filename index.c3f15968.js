var e={};e=JSON.parse('{"client_id":29536,"client_secret":"37c9da3a9b91852ab74f08d70259d5be24ca7a48"}');var t={},r={};function n(e){return Math.floor(Math.abs(e)+.5)*(e>=0?1:-1)}function o(e,t,r){var o=(e=n(e*r))-(t=n(t*r));o<<=1,e-t<0&&(o=~o);for(var a="";o>=32;)a+=String.fromCharCode((32|31&o)+63),o>>=5;return a+String.fromCharCode(o+63)}function a(e){for(var t=[],r=0;r<e.length;r++)t.push(e[r].slice().reverse());return t}r.decode=function(e,t){for(var r,n,o=0,a=0,i=0,l=[],s=0,d=0,c=null,u=Math.pow(10,t||5);o<e.length;){c=null,s=0,d=0;do d|=(31&(c=e.charCodeAt(o++)-63))<<s,s+=5;while(c>=32)r=1&d?~(d>>1):d>>1,s=d=0;do d|=(31&(c=e.charCodeAt(o++)-63))<<s,s+=5;while(c>=32)n=1&d?~(d>>1):d>>1,a+=r,i+=n,l.push([a/u,i/u])}return l},r.encode=function(e,t){if(!e.length)return"";for(var r=Math.pow(10,t||5),n=o(e[0][0],0,r)+o(e[0][1],0,r),a=1;a<e.length;a++){var i=e[a],l=e[a-1];n+=o(i[0],l[0],r),n+=o(i[1],l[1],r)}return n},r.fromGeoJSON=function(e,t){if(e&&"Feature"===e.type&&(e=e.geometry),!e||"LineString"!==e.type)throw Error("Input must be a GeoJSON LineString");return r.encode(a(e.coordinates),t)},r.toGeoJSON=function(e,t){return{type:"LineString",coordinates:a(r.decode(e,t))}},t&&(t=r);const i=new Promise(e=>{ymaps.ready(e)}),l=(e={})=>{let t=new ymaps.GeoObject({geometry:{type:"LineString",coordinates:e.coordinates},properties:{hintContent:e.label}},{strokeColor:e.color,strokeWidth:3,strokeOpacity:.5});return e.manual||(t.events.add("hover",e=>{e.originalEvent.target.options.set({strokeColor:"#0000ff",strokeOpacity:1,zIndex:999})}),t.events.add("mouseleave",t=>{t.originalEvent.target.options.set({strokeColor:e.color,strokeOpacity:.5,zIndex:0})})),t};let s=null,d=null;i.then(()=>{s=new ymaps.Map("ymap",{center:[0,0],zoom:10,controls:["zoomControl","rulerControl","typeSelector"]}),ymaps.geolocation.get({provider:"browser",mapStateAutoApply:!0}).then(e=>{e.geoObjects.options.set("preset","islands#blueCircleIcon"),s.geoObjects.add(e.geoObjects)}),d=new ymaps.GeoObjectCollection,s.geoObjects.add(d)});const c=e=>new Promise(t=>{let r=e.target.files[0],n=new FileReader;n.onload=e=>{t(e.target.result)},r.name.includes(".gpx")&&n.readAsText(r)}),u=(e,t)=>t.reduce((e,t)=>e&&e[t],e),p=([e,t],[r,n])=>{let{sin:o,cos:a,acos:i,PI:l}=Math,s=l*e/180,d=l*r/180,c=o(s)*o(d)+a(s)*a(d)*a(l*(t-n)/180);return 180*(c=i(c=c>1?1:c))/l*69.09*1.60934},h=e=>{let t=document.createElement("div");t.innerHTML=e;let r=(t.querySelector("gpx metadata name")||t.querySelector("gpx trk name")||{}).innerText,n=(t.querySelector("gpx metadata time")||{}).innerText,o=[...(t.querySelector("gpx trk trkseg")||{}).children||[]],a=o.map(e=>[parseFloat(e.attributes[0].value),parseFloat(e.attributes[1].value)]),i=a.reduce((e,t)=>({sum:e.prev?e.sum+p(e.prev,t):e.sum,prev:t}),{sum:0}).sum.toFixed(2);return{coordinates:a,label:`
        <div style="color: grey">
            ${r?`<div>${r}</div>`:""}
            ${n?`<div>${n}</div>`:""}
            <div>${i} \u{43A}\u{43C}.</div>
        </div>
    `,date:n,distance:i,duration:((new Date(u(o,[o.length-1,"children",1,"innerText"]))-new Date(u(o,[0,"children",1,"innerText"])))/36e5).toFixed(2)}};new Promise(e=>{document.addEventListener("DOMContentLoaded",e)}).then(()=>{document.querySelector(".upload input").addEventListener("change",e=>{c(e).then(e=>{let t=l({...h(e),color:"#0000ff",manual:!0});d.add(t)})},!1)});const f=([e,t,r])=>{if(e<0||e>360||t<0||t>100||r<0||r>100)return[0,0,0];let n=(1-Math.abs(2*(r/=100)-1))*(t/=100),o=n*(1-Math.abs(e/60%2-1)),a=r-n/2;return[[n,o,0],[o,n,0],[0,n,o],[0,o,n],[o,0,n],[n,0,o]][Math.floor(e/60)].map(e=>Math.round((e+a)*255))},m=([e,t,r])=>"#"+[e,t,r].map(e=>e.toString(16).padStart(2,"0")).join(""),y=(e,t=359)=>m(f([e*t,100,50])),v=e=>Array(e).fill(null).map((e,t,r)=>y(1/r.length*t)),g={All:"Все",Ride:"Велосипед",Walk:"Ходьба"},w=e=>g[e]||e;function _(e){this._seed=e%0x7fffffff,this._seed<=0&&(this._seed+=0x7ffffffe)}_.prototype.next=function(){return this._seed=16807*this._seed%0x7fffffff},_.prototype.nextFloat=function(){return(this.next()-1)/0x7ffffffe};const b=(e,t)=>fetch(e,{method:"GET",headers:new Headers({Authorization:"Bearer "+t})}),x=[...new URL(location.href).searchParams.entries()].reduce((e,[t,r])=>({...e,[t]:r}),{}),S=({collection:e,list:t,type:r,year:n,id:o})=>{e.removeAll(),t.forEach(t=>{("All"===r||t.type===r)&&("Год"===n||t.year==n)&&e.add(t.line),o&&t.id===o&&e.add(t.line)})};x.code?(async()=>{let r=await fetch("https://www.strava.com/oauth/token?"+[{client_id:e.client_id,client_secret:e.client_secret,code:x.code,grant_type:"authorization_code"}].reduce((e,t)=>Object.entries(t),0).map(([e,t])=>e+"="+t).join("&"),{method:"POST"}),n=(await r.json()).access_token,o=await b("https://www.strava.com/api/v3/athlete/activities?per_page=200",n),a=await o.json(),i=a,c=1;for(;a.length>=200;)c+=1,o=await b(`https://www.strava.com/api/v3/athlete/activities?per_page=200&page=${c}`,n),a=await o.json(),i=[...i,...a];let u=i.map(({start_date:e})=>new Date(e).toString().split(" ")[3]).reduce((e,t)=>e.includes(t)?e:e.concat([t]),[]),p=v(u.length),h=u.reduce((e,t)=>({...e,[t]:p.shift()}),{});i=i.map(({id:e,name:r,type:n,start_date:o,distance:a,elapsed_time:i,map:s},d)=>{var c;let u=((c=t)&&c.__esModule?c.default:c).decode(s.summary_polyline),p=new Date(o).toString().split("GMT")[0],f=parseFloat((a/1e3).toFixed(3)),m=parseFloat((i/3600).toFixed(3)),y=Number(p.split(" ")[3]),v=h[y],g=l({coordinates:u,label:`
          <a href="https://www.strava.com/activities/${e}" target="_blank">${r}</a>&nbsp;
          <a href="#${e}" class="only_me">#</a>
          <div style="color: grey">
            <div>${p}</div>
            <div>${f} \u{43A}\u{43C}. ${m} \u{447}.</div>
            <div>\u{422}\u{438}\u{43F}: ${w(n)}</div>
          </div>
        `,color:v});return{id:e,type:n,line:g,year:y,dist:f}});let f="Ride",m="Год",y=i.reduce((e,t)=>e.includes(t.type)?e:[...e,t.type],[]);y.unshift("All"),f=y.includes("Ride")?"Ride":y[0],S({collection:d,list:i,type:f,year:m}),s.setBounds(d.getBounds());let g=document.querySelector("#types");g.children[0].remove(),y.forEach(e=>{let t=document.createElement("option");t.value=e,t.innerText=w(e)+" ("+i.reduce((t,r)=>t+~~("All"===e||r.type===e),0)+")",e===f&&(t.selected=!0),g.appendChild(t)}),g.addEventListener("change",e=>{f=e.target.value,S({collection:d,list:i,type:f,year:m}),s.setBounds(d.getBounds())}),u=i.reduce((e,t)=>e.includes(t.year)?e:[...e,t.year],[]);let _=document.querySelector("#years");u.forEach(e=>{let t=document.createElement("option");t.value=e;let r=~~i.reduce((t,r)=>t+(r.year==e?r.dist:0),0),n=~~i.reduce((t,r)=>t+ +(r.year==e),0);t.innerText=e+("Год"!==e?` (${r} km / ${n})`:""),_.appendChild(t)}),_.addEventListener("change",e=>{m=e.target.value,S({collection:d,list:i,type:f,year:m}),s.setBounds(d.getBounds())}),document.querySelector("#showLabels").addEventListener("change",e=>{i.forEach(({line:t})=>{e.target.checked?t.properties.setAll({hintContent:t.properties.getAll()._hintContent}):t.properties.setAll({_hintContent:t.properties.getAll().hintContent,hintContent:""})})}),document.body.addEventListener("click",e=>{if(e.target.classList.contains("only_me")){let t=Number(e.target.href.split("#").pop());S({collection:d,list:i,id:t}),e.preventDefault()}})})():location.href="https://www.strava.com/oauth/authorize?"+[{client_id:e.client_id,redirect_uri:location.href.split("?")[0],response_type:"code",scope:"read,activity:read_all,profile:read_all,read_all"}].reduce((e,t)=>Object.entries(t),0).map(([e,t])=>e+"="+t).join("&");